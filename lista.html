<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lista General</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f9;
      padding: 20px;
    }
    h1, h2 { color: #1f3c88; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #1f3c88;
      color: white;
    }
    .total { font-weight: bold; margin-bottom: 10px; }

    button {
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
      font-weight: 600;
    }
    .btn-mod { background-color: #1f3c88; color: white; }
    .btn-cancel { background-color: #777; color: white; }
    .btn-del { background-color: #c0392b; color: white; }

    .ganancia { font-weight: bold; }
    .positiva { color: green; }
    .negativa { color: red; }

    /* ‚úÖ Separador de mes */
    .mes-row td{
      background: #e9eefc;
      color: #1f3c88;
      font-weight: 800;
      text-align: left;
      padding: 10px 12px;
      letter-spacing: .2px;
    }
    .mes-row .mes-wrap{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .mes-row .mes-ganancia{
      font-weight: 900;
    }
    .mes-row .mes-ganancia.positiva{ color: #1b7f2a; }
    .mes-row .mes-ganancia.negativa{ color: #b00020; }

    /* ‚úÖ Bloque de info mensual */
    .mes-subinfo{
      margin-top: 8px;
      display: grid;
      gap: 6px;
      font-weight: 700;
      color: #1f3c88;
    }
    .mes-subline{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      font-weight: 800;
    }
    .mes-subline .label{
      opacity: .95;
    }
    .mes-subline .value{
      font-weight: 900;
    }
    .mes-subline .value.negativa{ color:#b00020; }
    .mes-subline .value.positiva{ color:#1b7f2a; }

    /* ‚úÖ Bot√≥n plegable */
    .btn-toggle{
      background: #1f3c88;
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 800;
      font-size: 12px;
      width: fit-content;
    }
    .btn-toggle:hover{ opacity: .92; }

    .mes-fixed-details{
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.7);
      border: 1px dashed rgba(31,60,136,.25);
      display: grid;
      gap: 6px;
      font-weight: 600;
      color: #274bb0;
    }
    .fixed-item{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      opacity: .95;
    }
    .hidden{ display:none !important; }

    /* ‚úÖ Estados tipo "chip" */
    .estado-chip{
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .2px;
      border: 1px solid rgba(0,0,0,.08);
      white-space: nowrap;
    }
    .estado-pendiente{
      background: #fff3cd;
      color: #7a5a00;
      border-color: #ffe69c;
    }
    .estado-proceso{
      background: #e7f1ff;
      color: #0b4aa2;
      border-color: #cfe2ff;
    }
    .estado-finalizado{
      background: #d1e7dd;
      color: #0f5132;
      border-color: #badbcc;
    }
    .estado-adelanto{
      background: #f3e8ff;
      color: #5b21b6;
      border-color: #e9d5ff;
    }
    .estado-otro{
      background: #f1f3f5;
      color: #495057;
      border-color: #dee2e6;
    }

    /* Modal */
    #modalOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      padding: 20px;
    }
    #modal {
      max-width: 520px;
      margin: 40px auto;
      background: #fff;
      border-radius: 10px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    #modal h3 {
      margin: 0 0 12px 0;
      color: #1f3c88;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      margin-bottom: 10px;
      text-align: left;
    }
    label { font-weight: 700; color: #333; }
    input, select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: -6px;
      margin-bottom: 10px;
    }
    #mEstadoOtroWrap { display: none; }
  </style>
</head>
<body>

<h1>üìã Lista general</h1>

<h2>üß∞ Trabajos</h2>
<p class="total" id="totalTrabajos">Cargando...</p>

<table>
  <thead>
    <tr>
      <th>Descripci√≥n</th>
      <th>Cliente</th>
      <th>Ingreso</th>
      <th>Gastos</th>
      <th>Ganancia</th>
      <th>Fecha</th>
      <th>Estado</th>
      <th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody id="tablaTrabajos"></tbody>
</table>

<a href="index.html">‚¨Ö Volver al inicio</a>

<!-- MODAL -->
<div id="modalOverlay">
  <div id="modal">
    <h3>‚úèÔ∏è Modificar trabajo</h3>

    <div class="form-row">
      <label for="mDescripcion">Descripci√≥n</label>
      <input id="mDescripcion" type="text" placeholder="Ej: Cambio de bater√≠a">
    </div>

    <div class="form-row">
      <label for="mCliente">Cliente</label>
      <input id="mCliente" type="text" placeholder="Ej: Juan P√©rez">
    </div>

    <div class="form-row">
      <label for="mMonto">Ingreso ($)</label>
      <input id="mMonto" type="number" step="1" placeholder="Ej: 15000">
    </div>

    <div class="form-row">
      <label for="mGastos">Gastos ($)</label>
      <input id="mGastos" type="number" step="1" placeholder="Ej: 3000">
    </div>

    <div class="form-row">
      <label for="mFecha">Fecha</label>
      <input id="mFecha" type="date">
      <div class="hint">Se guarda autom√°ticamente como YYYY-MM-DD (ideal para ordenar).</div>
    </div>

    <div class="form-row">
      <label for="mEstado">Estado</label>
      <select id="mEstado">
        <option value="Pendiente">Pendiente</option>
        <option value="En proceso">En proceso</option>
        <option value="Finalizado">Finalizado</option>
        <option value="__otro__">Otro‚Ä¶</option>
      </select>
    </div>

    <div class="form-row" id="mEstadoOtroWrap">
      <label for="mEstadoOtro">Estado (Otro)</label>
      <input id="mEstadoOtro" type="text" placeholder="Ej: Adelanto / Entregado / Cobrado">
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
      <button class="btn-del" onclick="eliminarTrabajoActual()">Eliminar</button>
      <button class="btn-mod" onclick="guardarCambios()">Guardar cambios</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  deleteDoc,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB44Lxe4w7xrHkz9dQZ4y8I6W_QnRbNxuU",
  authDomain: "segural.firebaseapp.com",
  projectId: "segural",
  storageBucket: "segural.firebasestorage.app",
  messagingSenderId: "446640175127",
  appId: "1:446640175127:web:479a11474a70be0d604452"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tabla = document.getElementById("tablaTrabajos");
const totalTrabajos = document.getElementById("totalTrabajos");

const overlay = document.getElementById("modalOverlay");
const mDescripcion = document.getElementById("mDescripcion");
const mCliente = document.getElementById("mCliente");
const mMonto = document.getElementById("mMonto");
const mGastos = document.getElementById("mGastos");
const mFecha = document.getElementById("mFecha");
const mEstado = document.getElementById("mEstado");
const mEstadoOtroWrap = document.getElementById("mEstadoOtroWrap");
const mEstadoOtro = document.getElementById("mEstadoOtro");

let trabajosCache = {};
let trabajoActualId = null;

/* ‚úÖ Gastos fijos mensuales */
const GASTOS_FIJOS_MENSUALES = [
  { nombre: "Seguro Kangoo", monto: 56000 },
  { nombre: "Seguro personal Trabajo", monto: 47000 },
  { nombre: "Cuota social", monto: 24000 },
  { nombre: "Seguro Fiat punto", monto: 472300 },
  { nombre: "Pago mensual Kangoo 0km", monto: 428000 },
  { nombre: "Monotributo", monto: 131000 }
];
const TOTAL_GASTOS_FIJOS = GASTOS_FIJOS_MENSUALES.reduce((acc, it) => acc + (Number(it.monto) || 0), 0);

function fechaToMs(fecha) {
  if (!fecha) return 0;
  if (typeof fecha === "object" && typeof fecha.toDate === "function") return fecha.toDate().getTime();
  if (typeof fecha === "number") return fecha;
  if (typeof fecha === "string") {
    const s = fecha.trim();
    if (s.includes("/")) {
      const [dd, mm, yyyy] = s.split("/").map(n => parseInt(n, 10));
      if (yyyy && mm && dd) return new Date(yyyy, mm - 1, dd).getTime();
    }
    const ms = Date.parse(s);
    if (!Number.isNaN(ms)) return ms;
  }
  return 0;
}

function isoToEsAR(iso) {
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso);
  if (!m) return iso;
  return `${m[3]}/${m[2]}/${m[1]}`;
}

function mostrarFecha(fecha) {
  if (!fecha) return "";
  if (typeof fecha === "object" && typeof fecha.toDate === "function") return fecha.toDate().toLocaleDateString("es-AR");
  if (typeof fecha === "string") return isoToEsAR(fecha);
  return String(fecha);
}

function claveMes(fecha) {
  if (!fecha) return "Sin fecha";
  if (typeof fecha === "object" && typeof fecha.toDate === "function") {
    const d = fecha.toDate();
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
  }
  if (typeof fecha === "string") {
    const s = fecha.trim();
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
    if (m) return `${m[1]}-${m[2]}`;
    const m2 = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(s);
    if (m2) return `${m2[3]}-${m2[2]}`;
  }
  if (typeof fecha === "number") {
    const d = new Date(fecha);
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
  }
  return "Sin fecha";
}

const MESES = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
function tituloMes(key) {
  if (key === "Sin fecha") return "Sin fecha";
  const [yyyy, mm] = key.split("-");
  return `${MESES[Number(mm) - 1] || "Mes"} ${yyyy}`;
}

function fmtARS(n) {
  const val = Number(n) || 0;
  return `$${val.toLocaleString("es-AR")}`;
}

function estadoChipHTML(estadoRaw) {
  const e = (estadoRaw ?? "").toString().trim();
  const low = e.toLowerCase();

  let cls = "estado-otro";
  if (low.includes("pend")) cls = "estado-pendiente";
  else if (low.includes("final")) cls = "estado-finalizado";
  else if (low.includes("adel")) cls = "estado-adelanto";
  else if (low.includes("proceso") || low.includes("progreso") || low.includes("en proceso")) cls = "estado-proceso";

  return `<span class="estado-chip ${cls}">${e || "‚Äî"}</span>`;
}

/* ‚úÖ NUEVO: plegar/desplegar detalle gastos */
window.toggleDetallesGastos = function(keyMes) {
  const panel = document.getElementById(`detalles-${keyMes}`);
  const btn = document.getElementById(`btn-detalles-${keyMes}`);
  if (!panel || !btn) return;

  const hidden = panel.classList.toggle("hidden");
  btn.textContent = hidden ? "Ver detalle" : "Ocultar detalle";
};

function setEstadoUI(valor) {
  const opciones = ["Pendiente", "En proceso", "Finalizado"];
  if (opciones.includes(valor)) {
    mEstado.value = valor;
    mEstadoOtroWrap.style.display = "none";
    mEstadoOtro.value = "";
  } else {
    mEstado.value = "__otro__";
    mEstadoOtroWrap.style.display = "block";
    mEstadoOtro.value = valor || "";
  }
}

mEstado.addEventListener("change", () => {
  if (mEstado.value === "__otro__") {
    mEstadoOtroWrap.style.display = "block";
    mEstadoOtro.focus();
  } else {
    mEstadoOtroWrap.style.display = "none";
    mEstadoOtro.value = "";
  }
});

window.abrirModal = function(id) {
  const t = trabajosCache[id];
  if (!t) return alert("No se encontr√≥ el trabajo.");
  trabajoActualId = id;

  mDescripcion.value = t.descripcion ?? "";
  mCliente.value = t.cliente ?? "";
  mMonto.value = (t.monto ?? "") === "" ? "" : Number(t.monto);
  mGastos.value = (t.gastos ?? "") === "" ? "" : Number(t.gastos);

  if (typeof t.fecha === "object" && t.fecha?.toDate) {
    const d = t.fecha.toDate();
    mFecha.value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
  } else {
    const s = (t.fecha ?? "").toString().trim();
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
      const [dd, mm, yyyy] = s.split("/");
      mFecha.value = `${yyyy}-${mm}-${dd}`;
    } else {
      mFecha.value = s;
    }
  }

  setEstadoUI(t.estado ?? "");
  overlay.style.display = "block";
};

window.cerrarModal = function() {
  overlay.style.display = "none";
  trabajoActualId = null;
};

window.guardarCambios = async function() {
  if (!trabajoActualId) return;

  const descripcion = mDescripcion.value.trim();
  const cliente = mCliente.value.trim();
  const monto = Number(mMonto.value);
  const gastos = Number(mGastos.value);
  const fecha = (mFecha.value || "").trim();

  let estado = mEstado.value;
  if (estado === "__otro__") estado = mEstadoOtro.value.trim();

  if (!descripcion) return alert("Pon√© una descripci√≥n.");
  if (!cliente) return alert("Pon√© el cliente.");
  if (!fecha) return alert("Eleg√≠ una fecha.");
  if (Number.isNaN(monto)) return alert("Ingreso inv√°lido.");
  if (Number.isNaN(gastos)) return alert("Gastos inv√°lidos.");
  if (!estado) return alert("Eleg√≠ o escrib√≠ un estado.");

  try {
    await updateDoc(doc(db, "trabajos", trabajoActualId), { descripcion, cliente, monto, gastos, fecha, estado });
    cerrarModal();
    await cargarTrabajos();
  } catch (err) {
    alert("Error guardando cambios: " + err.message);
  }
};

window.eliminarTrabajoActual = async function() {
  if (!trabajoActualId) return;
  if (!confirm("¬øEliminar este trabajo?")) return;

  try {
    await deleteDoc(doc(db, "trabajos", trabajoActualId));
    cerrarModal();
    await cargarTrabajos();
  } catch (err) {
    alert("Error eliminando trabajo: " + err.message);
  }
};

async function cargarTrabajos() {
  tabla.innerHTML = "";
  let totalGanancia = 0;
  trabajosCache = {};

  const querySnapshot = await getDocs(collection(db, "trabajos"));
  const trabajos = querySnapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));

  trabajos.sort((a, b) => {
    const diff = fechaToMs(b.fecha) - fechaToMs(a.fecha);
    if (diff !== 0) return diff;
    return String(b.id).localeCompare(String(a.id));
  });

  // ganancia por mes (solo trabajos)
  const gananciaPorMes = {};
  trabajos.forEach((t) => {
    const ingreso = Number(t.monto) || 0;
    const gastos = Number(t.gastos) || 0;
    const g = ingreso - gastos;
    const k = claveMes(t.fecha);
    gananciaPorMes[k] = (gananciaPorMes[k] || 0) + g;
  });

  let mesActual = null;

  trabajos.forEach((trabajo) => {
    trabajosCache[trabajo.id] = trabajo;

    const ingreso = Number(trabajo.monto) || 0;
    const gastos = Number(trabajo.gastos) || 0;
    const ganancia = ingreso - gastos;
    totalGanancia += ganancia;

    const keyMes = claveMes(trabajo.fecha);

    if (keyMes !== mesActual) {
      mesActual = keyMes;

      const totalMes = gananciaPorMes[keyMes] || 0;
      const gastosFijosMes = (keyMes === "Sin fecha") ? 0 : TOTAL_GASTOS_FIJOS;
      const netoMes = totalMes - gastosFijosMes;

      const claseGanMes = totalMes >= 0 ? "positiva" : "negativa";
      const claseNetoMes = netoMes >= 0 ? "positiva" : "negativa";

      // keyMes tiene guion: "2026-02" => id seguro "2026-02"
      const detalleId = `detalles-${keyMes}`;
      const btnId = `btn-detalles-${keyMes}`;

      const filaMes = document.createElement("tr");
      filaMes.className = "mes-row";
      filaMes.innerHTML = `
        <td colspan="8">
          <div class="mes-wrap">
            <span>üìÖ ${tituloMes(keyMes)}</span>
            <span class="mes-ganancia ${claseGanMes}">Ganancia: ${fmtARS(totalMes)}</span>
          </div>

          ${keyMes === "Sin fecha" ? "" : `
            <div class="mes-subinfo">
              <div class="mes-subline">
                <span class="label">Gastos fijos del mes:</span>
                <span class="value negativa">-${fmtARS(gastosFijosMes)}</span>
              </div>
              <div class="mes-subline">
                <span class="label">Neto del mes:</span>
                <span class="value ${claseNetoMes}">${fmtARS(netoMes)}</span>
              </div>

              <button class="btn-toggle" id="${btnId}" onclick="toggleDetallesGastos('${keyMes}')">Ver detalle</button>

              <div class="mes-fixed-details hidden" id="${detalleId}">
                ${GASTOS_FIJOS_MENSUALES.map(it => `
                  <div class="fixed-item">
                    <span>${it.nombre}</span>
                    <span>-${fmtARS(it.monto)}</span>
                  </div>
                `).join("")}
              </div>
            </div>
          `}
        </td>
      `;
      tabla.appendChild(filaMes);
    }

    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${trabajo.descripcion ?? ""}</td>
      <td>${trabajo.cliente ?? ""}</td>
      <td>${fmtARS(ingreso)}</td>
      <td>${fmtARS(gastos)}</td>
      <td class="ganancia ${ganancia >= 0 ? 'positiva' : 'negativa'}">${fmtARS(ganancia)}</td>
      <td>${mostrarFecha(trabajo.fecha)}</td>
      <td>${estadoChipHTML(trabajo.estado)}</td>
      <td><button class="btn-mod" onclick="abrirModal('${trabajo.id}')">Modificar</button></td>
    `;
    tabla.appendChild(fila);
  });

  totalTrabajos.innerText = `üí∞ Ganancia total de trabajos: ${fmtARS(totalGanancia)} ‚Äî Gastos fijos mensuales: ${fmtARS(TOTAL_GASTOS_FIJOS)}`;
}

overlay.addEventListener("click", (e) => {
  if (e.target === overlay) cerrarModal();
});

cargarTrabajos();
</script>

</body>
</html>
