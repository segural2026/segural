<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lista General</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f9;
      padding: 20px;
    }
    h1, h2 { color: #1f3c88; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #1f3c88;
      color: white;
    }
    .total { font-weight: bold; margin-bottom: 10px; }

    button {
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
      font-weight: 600;
    }
    .btn-mod { background-color: #1f3c88; color: white; }
    .btn-cancel { background-color: #777; color: white; }
    .btn-del { background-color: #c0392b; color: white; }

    .ganancia { font-weight: bold; }
    .positiva { color: green; }
    .negativa { color: red; }

    /* Modal */
    #modalOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      padding: 20px;
    }
    #modal {
      max-width: 520px;
      margin: 40px auto;
      background: #fff;
      border-radius: 10px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    #modal h3 {
      margin: 0 0 12px 0;
      color: #1f3c88;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      margin-bottom: 10px;
      text-align: left;
    }
    label { font-weight: 700; color: #333; }
    input, select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: -6px;
      margin-bottom: 10px;
    }
    #mEstadoOtroWrap { display: none; }
  </style>
</head>
<body>

<h1>üìã Lista general</h1>

<h2>üß∞ Trabajos</h2>
<p class="total" id="totalTrabajos">Cargando...</p>

<table>
  <thead>
    <tr>
      <th>Descripci√≥n</th>
      <th>Cliente</th>
      <th>Ingreso</th>
      <th>Gastos</th>
      <th>Ganancia</th>
      <th>Fecha</th>
      <th>Estado</th>
      <th>Acci√≥n</th>
    </tr>
  </thead>
  <tbody id="tablaTrabajos"></tbody>
</table>

<a href="index.html">‚¨Ö Volver al inicio</a>

<!-- MODAL -->
<div id="modalOverlay">
  <div id="modal">
    <h3>‚úèÔ∏è Modificar trabajo</h3>

    <div class="form-row">
      <label for="mDescripcion">Descripci√≥n</label>
      <input id="mDescripcion" type="text" placeholder="Ej: Cambio de bater√≠a">
    </div>

    <div class="form-row">
      <label for="mCliente">Cliente</label>
      <input id="mCliente" type="text" placeholder="Ej: Juan P√©rez">
    </div>

    <div class="form-row">
      <label for="mMonto">Ingreso ($)</label>
      <input id="mMonto" type="number" step="1" placeholder="Ej: 15000">
    </div>

    <div class="form-row">
      <label for="mGastos">Gastos ($)</label>
      <input id="mGastos" type="number" step="1" placeholder="Ej: 3000">
    </div>

    <div class="form-row">
      <label for="mFecha">Fecha</label>
      <!-- Calendario -->
      <input id="mFecha" type="date">
      <div class="hint">Se guarda autom√°ticamente como YYYY-MM-DD (ideal para ordenar).</div>
    </div>

    <div class="form-row">
      <label for="mEstado">Estado</label>
      <select id="mEstado">
        <option value="Pendiente">Pendiente</option>
        <option value="En proceso">En proceso</option>
        <option value="Finalizado">Finalizado</option>
        <option value="__otro__">Otro‚Ä¶</option>
      </select>
    </div>

    <div class="form-row" id="mEstadoOtroWrap">
      <label for="mEstadoOtro">Estado (Otro)</label>
      <input id="mEstadoOtro" type="text" placeholder="Ej: Reprogramado / Entregado / Cobrado">
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
      <button class="btn-del" onclick="eliminarTrabajoActual()">Eliminar</button>
      <button class="btn-mod" onclick="guardarCambios()">Guardar cambios</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  deleteDoc,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB44Lxe4w7xrHkz9dQZ4y8I6W_QnRbNxuU",
  authDomain: "segural.firebaseapp.com",
  projectId: "segural",
  storageBucket: "segural.firebasestorage.app",
  messagingSenderId: "446640175127",
  appId: "1:446640175127:web:479a11474a70be0d604452"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tabla = document.getElementById("tablaTrabajos");
const totalTrabajos = document.getElementById("totalTrabajos");

const overlay = document.getElementById("modalOverlay");
const mDescripcion = document.getElementById("mDescripcion");
const mCliente = document.getElementById("mCliente");
const mMonto = document.getElementById("mMonto");
const mGastos = document.getElementById("mGastos");
const mFecha = document.getElementById("mFecha");
const mEstado = document.getElementById("mEstado");
const mEstadoOtroWrap = document.getElementById("mEstadoOtroWrap");
const mEstadoOtro = document.getElementById("mEstadoOtro");

let trabajosCache = {};      // id -> trabajo
let trabajoActualId = null;  // id que se est√° editando

function fechaToMs(fecha) {
  if (!fecha) return 0;

  // Firestore Timestamp
  if (typeof fecha === "object" && typeof fecha.toDate === "function") {
    return fecha.toDate().getTime();
  }

  if (typeof fecha === "number") return fecha;

  if (typeof fecha === "string") {
    const s = fecha.trim();

    // DD/MM/YYYY
    if (s.includes("/")) {
      const [dd, mm, yyyy] = s.split("/").map(n => parseInt(n, 10));
      if (yyyy && mm && dd) return new Date(yyyy, mm - 1, dd).getTime();
    }

    // ISO (YYYY-MM-DD)
    const ms = Date.parse(s);
    if (!Number.isNaN(ms)) return ms;
  }

  return 0;
}

function isoToEsAR(iso) {
  // iso: YYYY-MM-DD
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(iso);
  if (!m) return iso;
  const yyyy = m[1], mm = m[2], dd = m[3];
  return `${dd}/${mm}/${yyyy}`;
}

function mostrarFecha(fecha) {
  if (!fecha) return "";
  if (typeof fecha === "object" && typeof fecha.toDate === "function") {
    const d = fecha.toDate();
    return d.toLocaleDateString("es-AR");
  }
  if (typeof fecha === "string") return isoToEsAR(fecha);
  return String(fecha);
}

function setEstadoUI(valor) {
  // Si coincide con opciones, lo selecciona; si no, cae a "Otro"
  const opciones = ["Pendiente", "En proceso", "Finalizado"];
  if (opciones.includes(valor)) {
    mEstado.value = valor;
    mEstadoOtroWrap.style.display = "none";
    mEstadoOtro.value = "";
  } else {
    mEstado.value = "__otro__";
    mEstadoOtroWrap.style.display = "block";
    mEstadoOtro.value = valor || "";
  }
}

mEstado.addEventListener("change", () => {
  if (mEstado.value === "__otro__") {
    mEstadoOtroWrap.style.display = "block";
    mEstadoOtro.focus();
  } else {
    mEstadoOtroWrap.style.display = "none";
    mEstadoOtro.value = "";
  }
});

window.abrirModal = function(id) {
  const t = trabajosCache[id];
  if (!t) return alert("No se encontr√≥ el trabajo.");

  trabajoActualId = id;

  mDescripcion.value = t.descripcion ?? "";
  mCliente.value = t.cliente ?? "";
  mMonto.value = (t.monto ?? "") === "" ? "" : Number(t.monto);
  mGastos.value = (t.gastos ?? "") === "" ? "" : Number(t.gastos);

  // Fecha: si viene Timestamp => lo paso a YYYY-MM-DD para el input date
  if (typeof t.fecha === "object" && t.fecha?.toDate) {
    const d = t.fecha.toDate();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    mFecha.value = `${yyyy}-${mm}-${dd}`;
  } else {
    // si ya es string ISO YYYY-MM-DD, perfecto
    // si fuera DD/MM/YYYY, intento convertirlo
    const s = (t.fecha ?? "").toString().trim();
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
      const [dd, mm, yyyy] = s.split("/");
      mFecha.value = `${yyyy}-${mm}-${dd}`;
    } else {
      mFecha.value = s; // idealmente ISO
    }
  }

  setEstadoUI(t.estado ?? "");

  overlay.style.display = "block";
};

window.cerrarModal = function() {
  overlay.style.display = "none";
  trabajoActualId = null;
};

window.guardarCambios = async function() {
  if (!trabajoActualId) return;

  const descripcion = mDescripcion.value.trim();
  const cliente = mCliente.value.trim();
  const monto = Number(mMonto.value);
  const gastos = Number(mGastos.value);

  // type="date" devuelve YYYY-MM-DD
  const fecha = (mFecha.value || "").trim();

  let estado = mEstado.value;
  if (estado === "__otro__") estado = mEstadoOtro.value.trim();

  if (!descripcion) return alert("Pon√© una descripci√≥n.");
  if (!cliente) return alert("Pon√© el cliente.");
  if (!fecha) return alert("Eleg√≠ una fecha.");
  if (Number.isNaN(monto)) return alert("Ingreso inv√°lido.");
  if (Number.isNaN(gastos)) return alert("Gastos inv√°lidos.");
  if (!estado) return alert("Eleg√≠ o escrib√≠ un estado.");

  try {
    await updateDoc(doc(db, "trabajos", trabajoActualId), {
      descripcion,
      cliente,
      monto,
      gastos,
      fecha,   // se guarda ISO YYYY-MM-DD
      estado
    });

    cerrarModal();
    await cargarTrabajos();
  } catch (err) {
    alert("Error guardando cambios: " + err.message);
  }
};

window.eliminarTrabajoActual = async function() {
  if (!trabajoActualId) return;
  if (!confirm("¬øEliminar este trabajo?")) return;

  try {
    await deleteDoc(doc(db, "trabajos", trabajoActualId));
    cerrarModal();
    await cargarTrabajos();
  } catch (err) {
    alert("Error eliminando trabajo: " + err.message);
  }
};

async function cargarTrabajos() {
  tabla.innerHTML = "";
  let totalGanancia = 0;
  trabajosCache = {};

  const querySnapshot = await getDocs(collection(db, "trabajos"));

  const trabajos = querySnapshot.docs.map((docSnap) => ({
    id: docSnap.id,
    ...docSnap.data()
  }));

  // Orden: nuevo arriba
  trabajos.sort((a, b) => {
    const diff = fechaToMs(b.fecha) - fechaToMs(a.fecha);
    if (diff !== 0) return diff;
    return String(b.id).localeCompare(String(a.id)); // desempate estable
  });

  trabajos.forEach((trabajo) => {
    trabajosCache[trabajo.id] = trabajo;

    const ingreso = Number(trabajo.monto) || 0;
    const gastos = Number(trabajo.gastos) || 0;
    const ganancia = ingreso - gastos;
    totalGanancia += ganancia;

    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${trabajo.descripcion ?? ""}</td>
      <td>${trabajo.cliente ?? ""}</td>
      <td>$${ingreso.toLocaleString("es-AR")}</td>
      <td>$${gastos.toLocaleString("es-AR")}</td>
      <td class="ganancia ${ganancia >= 0 ? 'positiva' : 'negativa'}">$${ganancia.toLocaleString("es-AR")}</td>
      <td>${mostrarFecha(trabajo.fecha)}</td>
      <td>${trabajo.estado ?? ""}</td>
      <td><button class="btn-mod" onclick="abrirModal('${trabajo.id}')">Modificar</button></td>
    `;
    tabla.appendChild(fila);
  });

  totalTrabajos.innerText = `üí∞ Ganancia total de trabajos: $${totalGanancia.toLocaleString("es-AR")}`;
}

// Cerrar modal tocando afuera
overlay.addEventListener("click", (e) => {
  if (e.target === overlay) cerrarModal();
});

cargarTrabajos();
</script>

</body>
</html>
